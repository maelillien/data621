---
title: "DATA621 Blog 2"
author: "Mael Illien"
date: "11/27/2020"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    highlight: pygments
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse) #readr, dplyr, tidyr, stringr, tibble, ggplot2
library(knitr)
library(scales)
library(kableExtra)
library(readxl)
library(ggrepel)
library(skimr)
```

```{r include=FALSE}
showtable <- function(data, title) {
  kable(data, caption = title) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
}
```

# Multiple Regression

## Introduction 

A paramount concern in agriculture is maximizing crop production and regression analysis can be used to assist in solving that problem in a number of ways. We can use it to answer questions like:
- What are the environmental and meteorological factors that influence crop yield?
- Given meteorological and/or environmental/spatial information about a crop area during the ongoing growing season, can we predict the crop’s yield for that year?
- Can we predict crop loss due to inclement weather?

These questions can be answered using a multiple regression model with a continuous response variable (yield in unit qty) and a combination of continuous and discrete predictor variables. 

From the variety of factors that may impact a crop’s yield, there are a number of sensible predictors that may affect yield such as:
- Location (are particular regions of the world more or less productive). If you comparing countries, the overall crop area for production per country might also be useful.  
- Low, average, high temperatures for individual months or growing periods (growth, bloom, seed)
  - Can be used to derive binary variables such as: occurrence of frost or occurence of overheating
- Precipitation data
  - Can be used to determine the occurence of drought

This situation lends itself to Linear Modeling using multiple regression with continuous and discrete variables
- Explanation: 1 degree rise in temperature = 25% raise
- Prediction: 

```{r include=FALSE}
# years <- seq(2000,2019,1)
# avg_precipitation <- 
# avg_temperature
```

The data below is gathered from multiple sources for illustrative purposes but does not form a coherent dataset.

# US Production & Fresno Meteorological Data

Below is a chart of the US production of a crap from 2014 to 2019. In this case the crop is raisins. We also acquired meteorological data from NOAA for Fresno Country in California which is an area where raisins are grown. 

The plots below show how the data is distributed for temperature and precipation over the months of a year. We notice a few outliers in both temperature and precipitation which could be investigated further to determine if the yield that year was particularly affected. 

```{r include=FALSE}
year = c(2014,2015,2016,2017,2018,2019)
production = c(368408,332211,352441,304723,241402,263000)
us_production <- tibble(YEAR = year, PRODUCTION = production)
#us_production <- us_production %>% filter(year != 2016)

fresno <- read_csv('fresno.csv')
fresno <- fresno %>% 
  select(DATE,PRCP,TAVG:TMIN) %>% 
  separate(DATE, sep="-", into = c('YEAR','MONTH')) %>% 
  mutate(YEAR = as.numeric(YEAR))

tmin <- fresno %>% select(YEAR, MONTH, TMIN) %>% spread(MONTH,TMIN) %>% left_join(us_production, by='YEAR')
tmax <- fresno %>% select(YEAR, MONTH, TMAX) %>% spread(MONTH,TMAX) %>% left_join(us_production, by='YEAR')
tavg <- fresno %>% select(YEAR, MONTH, TAVG) %>% spread(MONTH,TAVG) %>% left_join(us_production, by='YEAR')
prcp <- fresno %>% select(YEAR, MONTH, PRCP) %>% spread(MONTH,PRCP) %>% left_join(us_production, by='YEAR')

fresno_long <- fresno %>% gather(key=METRIC, value=VALUE, PRCP:TMIN)
```

```{r include=FALSE}
ggplot(us_production, aes(x=YEAR, y=PRODUCTION)) + 
  geom_col() + 
  ggtitle("US Production (tons)") + 
  scale_y_continuous(breaks=seq(0,350000,50000))

ggplot(fresno_long %>% filter(METRIC != "PRCP"), aes(x=MONTH,y=VALUE,color=METRIC)) + 
  geom_boxplot() +
  ggtitle("Temperature Monthly Distribution")

ggplot(fresno_long %>% filter(METRIC == "PRCP"), aes(x=MONTH,y=VALUE,color=METRIC)) + 
  geom_boxplot() +
  ggtitle("Precipitation Monthly Distribution")
```

```{r}
#data <- us_production %>% mutate(jun_rain=, )
model_data <- cbind(us_production,
      prcp %>% filter(!YEAR %in% c(2012,2013)) %>% replace(is.na(.), 0) %>% transmute(yearlyprcp=rowSums(.[2:13]), jun_rain=`06`>0, jul_rain=`07`>0, aug_rain=`08`>0, wetwinter=`12`+`01`>5, drywinter=`12`+`01`<3),
      tmin %>% filter(!YEAR %in% c(2012,2013)) %>% transmute(colddec=`12` < 35, coldjan=`01` < 35) %>% replace(is.na(.), FALSE)
      )

model_data

showtable(model_data, title="Assembled Modeling Data")
```

```{r}
lm.1 <- lm(PRODUCTION ~ ., data=model_data %>% select(-YEAR))
summary(lm.1)
```

